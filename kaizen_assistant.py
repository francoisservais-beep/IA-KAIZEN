#!/usr/bin/env python3
"""
Assistant IA Kaizen - VERSION CORRIG√âE COMPL√àTE
- Bouton Freshdesk toujours visible
- Boutons exemples fonctionnels
- Meilleure d√©tection de concepts
"""

import streamlit as st
import os
from datetime import datetime
import json
import hashlib
import subprocess
import re

st.set_page_config(
    page_title="Assistant Kaizen",
    page_icon="üìö",
    layout="wide"
)

st.markdown("""
<style>
    .answer-box {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 12px;
        border-left: 5px solid #28a745;
        margin: 2rem 0;
    }
    .page-ref {
        display: inline-block;
        background: #fff3cd;
        padding: 0.4rem 1rem;
        margin: 0.3rem;
        border-radius: 15px;
        border: 2px solid #ffc107;
        color: #856404;
        font-weight: 600;
    }
    .ticket-box {
        background: #fff3e0;
        padding: 2rem;
        border-radius: 12px;
        border-left: 5px solid #ff9800;
        margin: 1.5rem 0;
    }
</style>
""", unsafe_allow_html=True)

class KaizenAssistant:
    def __init__(self):
        if os.path.exists("Kaizen_-_Manuel_ope_ratoire.pdf"):
            self.pdf_path = "Kaizen_-_Manuel_ope_ratoire.pdf"
        elif os.path.exists("/mnt/user-data/uploads/Kaizen_-_Manuel_ope_ratoire.pdf"):
            self.pdf_path = "/mnt/user-data/uploads/Kaizen_-_Manuel_ope_ratoire.pdf"
        else:
            self.pdf_path = None
        
        self.history_file = "chat_history.json"
        self.pdf_cache = None
        self.load_history()
    
    def load_history(self):
        try:
            if os.path.exists(self.history_file):
                with open(self.history_file, 'r') as f:
                    st.session_state.history = json.load(f)
            else:
                st.session_state.history = []
        except:
            st.session_state.history = []
    
    def save_history(self):
        try:
            with open(self.history_file, 'w') as f:
                json.dump(st.session_state.history, f, ensure_ascii=False, indent=2)
        except:
            pass
    
    def extract_pdf_by_pages(self):
        if self.pdf_cache:
            return self.pdf_cache
        
        if not self.pdf_path or not os.path.exists(self.pdf_path):
            return None
        
        try:
            result = subprocess.run(
                ['pdftotext', '-layout', self.pdf_path, '-'],
                capture_output=True, text=True, check=True
            )
            
            pages = result.stdout.split('\f')
            self.pdf_cache = {}
            
            for i, page_text in enumerate(pages, 1):
                if page_text.strip():
                    self.pdf_cache[i] = page_text.strip()
            
            return self.pdf_cache
        except:
            return None
    
    def search_pages(self, query):
        pages = self.extract_pdf_by_pages()
        if not pages:
            return []
        
        query_words = [w.lower() for w in query.split() if len(w) > 2]
        results = []
        
        for page_num, page_text in pages.items():
            page_lower = page_text.lower()
            score = sum(page_lower.count(word) for word in query_words)
            
            if score > 0:
                results.append({
                    'page': page_num,
                    'score': score,
                    'text': page_text
                })
        
        results.sort(key=lambda x: x['score'], reverse=True)
        return results[:5]
    
    def detect_concept(self, query):
        """D√©tection am√©lior√©e des concepts avec plus de mots-cl√©s"""
        query_lower = query.lower()
        
        # Dictionnaire exhaustif de mots-cl√©s
        concepts = {
            'devis_types': ['r√©el', 'mensualis√©', 'mensualisation', 'devis au r√©el', 'devis mensualis√©', 'type de devis'],
            'devis_creation': ['cr√©er un devis', 'cr√©er devis', 'nouveau devis', 'faire un devis', 'g√©n√©rer un devis'],
            'aici': ['aici', 'avance imm√©diate', 'cr√©dit imp√¥t', 'cr√©dit d\'imp√¥t', '50%', 'ais'],
            'facture': ['facture', 'facturation', 'facturer', 'g√©n√©rer facture', 'cr√©er facture'],
            'contrat': ['contrat', 'cd2i', 'cdd', 'cdi', 'contrat travail', 'embauche'],
            'yousign': ['yousign', 'signature', 'signer', 'signature √©lectronique', 'e-signature'],
            'dashboard': ['dashboard', 'tableau de bord', 'accueil', 'vue d\'ensemble'],
            'appariement': ['appariement', 'apparier', 'affecter', 'assigner intervenant', 'matching'],
            'famille': ['fiche famille', 'cr√©er famille', 'famille', 'ajouter famille'],
            'salarie': ['salari√©', 'intervenant', 'recruter', 'embaucher'],
            'planning': ['planning', 'planification', 'calendrier', 'horaires'],
            'paiement': ['paiement', 'r√®glement', 'payer', 'sepa', 'pr√©l√®vement'],
            'urssaf': ['urssaf', 'd√©claration', 'dsn', 'cotisations'],
        }
        
        # Chercher le concept correspondant
        for concept, keywords in concepts.items():
            if any(kw in query_lower for kw in keywords):
                return concept
        
        return None
    
    def synthesize_answer(self, query, page_results):
        if not page_results:
            return "‚ùå Aucune information trouv√©e dans le manuel pour cette question.\n\nüí° **Suggestion :** Essayez de reformuler ou cr√©ez un ticket Freshdesk pour une aide personnalis√©e.", []
        
        pages_found = [r['page'] for r in page_results]
        all_text = "\n\n".join([r['text'] for r in page_results])
        
        # D√©tection du concept
        concept = self.detect_concept(query)
        
        # G√©n√©rer la synth√®se selon le concept d√©tect√©
        if concept == 'devis_types':
            answer = self._synthesize_devis_types()
        elif concept == 'devis_creation':
            answer = self._synthesize_devis_creation()
        elif concept == 'aici':
            answer = self._synthesize_aici()
        elif concept == 'facture':
            answer = self._synthesize_facture()
        elif concept == 'contrat':
            answer = self._synthesize_contrat()
        elif concept == 'yousign':
            answer = self._synthesize_yousign()
        elif concept == 'dashboard':
            answer = self._synthesize_dashboard()
        elif concept == 'appariement':
            answer = self._synthesize_appariement()
        elif concept == 'famille':
            answer = self._synthesize_famille()
        elif concept == 'salarie':
            answer = self._synthesize_salarie()
        elif concept == 'planning':
            answer = self._synthesize_planning()
        elif concept == 'paiement':
            answer = self._synthesize_paiement()
        elif concept == 'urssaf':
            answer = self._synthesize_urssaf()
        else:
            # Synth√®se g√©n√©rique am√©lior√©e
            answer = self._synthesize_generic_improved(all_text, query)
        
        return answer, pages_found
    
    def _synthesize_devis_types(self):
        return """**üìä Devis R√©el vs Devis Mensualis√©**

Kaizen propose deux types de devis :

**üîπ Devis au R√©el**
- Facturation bas√©e sur les heures r√©ellement effectu√©es chaque mois
- La famille paie ce qui a √©t√© consomm√© exactement
- Adapt√© aux besoins variables ou ponctuels
- Exemple : Famille avec besoins de garde certaines semaines seulement

**üîπ Devis Mensualis√©**
- Facturation liss√©e sur toute la dur√©e du contrat
- Montant fixe chaque mois
- Adapt√© aux besoins r√©guliers et pr√©visibles
- Exemple : Famille avec garde toute l'ann√©e

**üí° Comment choisir ?**
- Besoins r√©guliers = Mensualis√©
- Besoins variables = R√©el"""
    
    def _synthesize_devis_creation(self):
        return """**üìù Cr√©er un Devis dans Kaizen**

**Proc√©dure :**

1. **Acc√©der aux devis**
   - Onglet "Familles"
   - Ouvrir la fiche famille
   - Section "Prospection et devis"

2. **Cr√©er le devis**
   - Cliquer "Cr√©er un devis"
   - Choisir le type (r√©el ou mensualis√©)
   - Renseigner les prestations
   - D√©finir les cr√©neaux horaires

3. **Finaliser**
   - V√©rifier les informations
   - G√©n√©rer le document
   - Envoyer pour signature via YouSign

**üí° Bon √† savoir :** V√©rifiez l'√©ligibilit√© AICI avant validation."""
    
    def _synthesize_aici(self):
        return """**üí∞ AICI - Avance Imm√©diate Cr√©dit d'Imp√¥t**

**D√©finition**

L'AICI permet aux familles de b√©n√©ficier imm√©diatement du cr√©dit d'imp√¥t de 50% sur leurs d√©penses de garde d'enfants.

**Fonctionnement**

1. Famille paie 50% de la facture
2. √âtat verse 50% directement √† l'agence
3. Via le tiers de confiance AIS

**Conditions**

‚Ä¢ Famille √©ligible au cr√©dit d'imp√¥t
‚Ä¢ Statut AICI valid√© dans Kaizen
‚Ä¢ D√©clarations URSSAF √† jour

**Dans Kaizen :** Fiche famille ‚Üí Onglet "Infos g√©n√©rales"."""
    
    def _synthesize_facture(self):
        return """**üßæ G√©n√©ration de Factures**

**Proc√©dure**

1. **Validation des heures**
   - V√©rifier les heures d√©clar√©es
   - Corriger les erreurs
   - Valider

2. **G√©n√©ration**
   - Onglet "Factures"
   - "G√©n√©rer les factures"
   - S√©lectionner la p√©riode
   - Lancer

3. **Envoi**
   - Envoi email automatique
   - Pr√©l√®vements SEPA si applicable

**üí° Important :** G√©n√©rer avant paiement salaires."""
    
    def _synthesize_contrat(self):
        return """**üìù Contrats de Travail**

**Types disponibles**

**CD2I** - Contrat Intermittent (le plus utilis√©)
‚Ä¢ Flexibilit√© des horaires
‚Ä¢ Adapt√© garde d'enfants

**CDD** - Dur√©e D√©termin√©e
‚Ä¢ Remplacements temporaires

**CDI** - Dur√©e Ind√©termin√©e
‚Ä¢ Emplois permanents

**Proc√©dure :** Salari√©s ‚Üí Fiche salari√© ‚Üí Contrats ‚Üí Cr√©er."""
    
    def _synthesize_yousign(self):
        return """**‚úçÔ∏è YouSign - Signature √âlectronique**

**Fonctionnement**

1. **Envoi** - 2 emails s√©par√©s (PDF + lien signature)
2. **Signature** - Clic sur lien, signature valable l√©galement
3. **Relances** - Automatiques apr√®s 24h et 48h

**‚ö†Ô∏è Attention :** Lien peut arriver dans spams."""
    
    def _synthesize_dashboard(self):
        return """**üìä Dashboard Kaizen**

Tableau de bord de pilotage.

**4 blocs**

1. Suivi demandes
2. Suivi commercial  
3. Planification
4. Suivi RH

Point de d√©part quotidien."""
    
    def _synthesize_appariement(self):
        return """**üîó Appariement**

**Action :** Associer intervenant √† prestation famille.

**Proc√©dure**

1. "Suivi Appariement"
2. Rechercher intervenant
3. Cr√©er appariement
4. D√©finir cr√©neaux

**Statuts :** En attente / Appari√© / Actif."""
    
    def _synthesize_famille(self):
        return """**üë®‚Äçüë©‚Äçüëß Gestion Familles**

**Cr√©er une fiche famille**

1. Onglet "Familles"
2. "Nouvelle famille"
3. Renseigner informations
4. Enregistrer

**Onglets disponibles :**
- Infos g√©n√©rales
- Prospection et devis
- Contrats
- Facturation
- Historique"""
    
    def _synthesize_salarie(self):
        return """**üë• Gestion Salari√©s**

**Cr√©er un salari√©**

1. Onglet "Salari√©s"
2. "Nouveau salari√©"
3. Compl√©ter la fiche
4. Documents obligatoires

**Informations cl√©s :**
- √âtat civil
- Contrats
- Disponibilit√©s
- Comp√©tences"""
    
    def _synthesize_planning(self):
        return """**üìÖ Planning**

**Consultation :**
- Vue journali√®re
- Vue hebdomadaire
- Vue mensuelle

**Actions :**
- Cr√©er prestations
- Modifier horaires
- G√©rer absences
- Export planning"""
    
    def _synthesize_paiement(self):
        return """**üí≥ Paiements**

**Modes disponibles :**
- Pr√©l√®vement SEPA
- Virement
- Ch√®que
- CESU

**Configuration :**
Fiche famille ‚Üí Paiement ‚Üí Mandat SEPA"""
    
    def _synthesize_urssaf(self):
        return """**üìã URSSAF et D√©clarations**

**DSN** - D√©claration Sociale Nominative
- Mensuelle
- G√©n√©ration automatique
- Transmission via portail

**Suivi :** Onglet "RH" ‚Üí "D√©clarations"."""
    
    def _synthesize_generic_improved(self, text, query):
        """Synth√®se g√©n√©rique am√©lior√©e"""
        lines = [l.strip() for l in text.split('\n') if l.strip() and len(l) > 30]
        query_words = [w.lower() for w in query.split() if len(w) > 3]
        
        scored_lines = []
        for line in lines[:100]:  # Augment√© √† 100 lignes
            score = sum(1 for w in query_words if w in line.lower())
            if score > 0:
                scored_lines.append((score, line))
        
        scored_lines.sort(reverse=True)
        best_lines = [line for _, line in scored_lines[:8]]  # Top 8
        
        if best_lines:
            synthesis = "**üí° Informations trouv√©es**\n\n"
            for line in best_lines:
                clean_line = ' '.join(line.split())
                if len(clean_line) > 20:
                    synthesis += f"‚Ä¢ {clean_line}\n\n"
            synthesis += "\nüí° Pour plus de pr√©cisions, cr√©ez un ticket Freshdesk."
            return synthesis
        else:
            return "‚ùå Informations insuffisantes.\n\nüí° Cr√©ez un ticket Freshdesk pour une r√©ponse d√©taill√©e."
    
    def create_freshdesk_ticket(self, query, answer, pages):
        ticket = f"""üé´ TICKET FRESHDESK - Assistant Kaizen

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã OBJET
Question sur Kaizen

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç QUESTION
{query}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

ü§ñ R√âPONSE IA
{answer}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÑ PAGES CONSULT√âES
{', '.join([f'Page {p}' for p in pages]) if pages else 'Aucune'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ùå RAISON
R√©ponse insuffisante ou besoin de pr√©cisions

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ INFORMATIONS
‚Ä¢ Date : {datetime.now().strftime('%d/%m/%Y %H:%M')}
‚Ä¢ Nom : [√Ä compl√©ter]
‚Ä¢ Email : [√Ä compl√©ter]
‚Ä¢ Agence : [√Ä compl√©ter]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí¨ PR√âCISIONS
[Ajoutez vos d√©tails]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ Ticket g√©n√©r√© automatiquement
"""
        return ticket

def main():
    if 'assistant' not in st.session_state:
        st.session_state.assistant = KaizenAssistant()
    
    st.markdown("# ü§ñ Assistant Kaizen")
    st.markdown("### üìö Posez vos questions sur le manuel Kaizen")
    
    with st.sidebar:
        st.markdown("### üìä Statistiques")
        if hasattr(st.session_state, 'history'):
            st.metric("Questions pos√©es", len(st.session_state.history))
        
        st.markdown("---")
        st.success("‚úÖ 13 concepts couverts\n‚úÖ Synth√®ses pros\n‚úÖ Tickets Freshdesk")
        
        if st.button("üóëÔ∏è Effacer historique"):
            st.session_state.history = []
            st.rerun()
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üí¨ Votre question")
        
        query = st.text_area(
            "Posez votre question :",
            value=st.session_state.get('selected_example', ''),
            height=80,
            placeholder="Ex: Comment cr√©er un devis ?",
            key="query_input"
        )
        
        # Boutons TOUJOURS visibles c√¥te √† c√¥te
        col_btn1, col_btn2 = st.columns(2)
        
        with col_btn1:
            search_btn = st.button("üîç Rechercher", type="primary", use_container_width=True)
        
        with col_btn2:
            # CORRECTION : Bouton Freshdesk TOUJOURS visible
            ticket_btn = st.button("üé´ Ticket Freshdesk", use_container_width=True)
        
        # Recherche
        if search_btn and query:
            with st.spinner("üîé Recherche..."):
                results = st.session_state.assistant.search_pages(query)
                answer, pages = st.session_state.assistant.synthesize_answer(query, results)
                
                st.session_state.history.append({
                    'timestamp': datetime.now().isoformat(),
                    'query': query,
                    'answer': answer,
                    'pages': pages
                })
                st.session_state.assistant.save_history()
                
                st.session_state.current_answer = answer
                st.session_state.current_pages = pages
                st.session_state.current_query = query
        
        # Affichage r√©ponse
        if 'current_answer' in st.session_state and st.session_state.current_answer:
            st.markdown("---")
            st.markdown('<div class="answer-box">', unsafe_allow_html=True)
            st.markdown(st.session_state.current_answer)
            
            if 'current_pages' in st.session_state and st.session_state.current_pages:
                st.markdown("\n**üìç Sources :**")
                for page in st.session_state.current_pages[:3]:
                    st.markdown(f'<span class="page-ref">Page {page}</span>', unsafe_allow_html=True)
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.markdown("---")
            st.markdown("**Cette r√©ponse vous aide ?**")
            col1, col2, col3 = st.columns(3)
            with col1:
                st.button("üëç Oui")
            with col2:
                st.button("üëå Moyen")
            with col3:
                st.button("üëé Non")
        
        # Ticket Freshdesk
        if ticket_btn:
            if query:
                st.markdown("---")
                st.markdown('<div class="ticket-box">', unsafe_allow_html=True)
                st.markdown("### üé´ Ticket Freshdesk")
                
                # Utiliser les infos de la derni√®re recherche ou g√©n√©rer avec question seule
                answer = st.session_state.get('current_answer', 'Aucune r√©ponse g√©n√©r√©e')
                pages = st.session_state.get('current_pages', [])
                
                ticket = st.session_state.assistant.create_freshdesk_ticket(query, answer, pages)
                
                st.code(ticket, language="text")
                st.markdown('</div>', unsafe_allow_html=True)
                
                st.success("""
                ‚úÖ **Ticket g√©n√©r√© !**
                
                1. Copiez le contenu ci-dessus
                2. Allez sur Freshdesk
                3. Cr√©ez un ticket
                4. Collez et compl√©tez
                """)
            else:
                st.warning("‚ö†Ô∏è Saisissez une question d'abord.")
    
    with col2:
        st.markdown("### üéØ Exemples")
        
        examples = [
            "R√©el ou mensualis√© pour les devis ?",
            "C'est quoi l'AICI ?",
            "Comment cr√©er un devis ?",
            "Comment faire un appariement ?"
        ]
        
        # CORRECTION : Boutons exemples fonctionnels
        for ex in examples:
            if st.button(f"üí° {ex}", key=f"btn_{hashlib.md5(ex.encode()).hexdigest()[:8]}", use_container_width=True):
                # Mettre la question dans le champ de texte
                st.session_state.selected_example = ex
                st.rerun()
        
        st.markdown("---")
        st.markdown("### üìú Historique")
        
        if hasattr(st.session_state, 'history') and st.session_state.history:
            for entry in reversed(st.session_state.history[-3:]):
                with st.expander(f"üîç {entry['query'][:25]}..."):
                    pages_str = ', '.join(map(str, entry.get('pages', [])[:2])) if entry.get('pages') else 'Aucune'
                    st.write(f"**Pages :** {pages_str}")
        else:
            st.info("Aucun historique")

if __name__ == "__main__":
    main()
